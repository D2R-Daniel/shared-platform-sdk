openapi: 3.0.3
info:
  title: User Management API
  description: |
    User management endpoints for CRUD operations on user accounts.

    Features:
    - User listing with filtering and pagination
    - User creation and invitation
    - User profile management
    - Bulk operations (import/export)
    - User status management
  version: 1.0.0
  contact:
    name: Platform Team

servers:
  - url: '{baseUrl}/api/v1'
    variables:
      baseUrl:
        default: https://api.example.com
        description: Base API URL

tags:
  - name: Users
    description: User account management
  - name: Bulk Operations
    description: Bulk user operations

security:
  - bearerAuth: []

paths:
  /users:
    get:
      operationId: listUsers
      summary: List users
      description: |
        Retrieve a paginated list of users with optional filtering.
        Results are scoped to the current tenant.
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - $ref: '#/components/parameters/SortParam'
        - $ref: '#/components/parameters/SearchParam'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/UserStatus'
          description: Filter by user status
        - name: role
          in: query
          schema:
            type: string
          description: Filter by role
        - name: team_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by team
        - name: created_after
          in: query
          schema:
            type: string
            format: date-time
          description: Filter users created after this date
        - name: created_before
          in: query
          schema:
            type: string
            format: date-time
          description: Filter users created before this date
      responses:
        '200':
          description: Paginated user list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      operationId: createUser
      summary: Create a new user
      description: |
        Create a new user account. The user will receive an email
        to set their password if email verification is enabled.
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: User with this email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{userId}:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'

    get:
      operationId: getUser
      summary: Get user by ID
      description: Retrieve a specific user's details
      tags:
        - Users
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      operationId: updateUser
      summary: Update user
      description: Update a user's account information
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      operationId: deleteUser
      summary: Delete user
      description: |
        Soft delete a user account. The user can be restored within
        the retention period.
      tags:
        - Users
      responses:
        '204':
          description: User deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{userId}/status:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'

    patch:
      operationId: updateUserStatus
      summary: Update user status
      description: Activate, deactivate, or suspend a user account
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: '#/components/schemas/UserStatus'
                reason:
                  type: string
                  description: Reason for status change
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{userId}/roles:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'

    put:
      operationId: updateUserRoles
      summary: Update user roles
      description: Replace user's roles with the provided list
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - roles
              properties:
                roles:
                  type: array
                  items:
                    type: string
                  minItems: 1
                  description: New roles for the user
      responses:
        '200':
          description: Roles updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{userId}/password:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'

    post:
      operationId: resetUserPassword
      summary: Reset user password
      description: |
        Initiate password reset for a user. Sends reset email
        or returns temporary password based on configuration.
      tags:
        - Users
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                send_email:
                  type: boolean
                  default: true
                  description: Whether to send reset email
      responses:
        '200':
          description: Password reset initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  temporary_password:
                    type: string
                    description: Only returned if send_email is false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/invite:
    post:
      operationId: inviteUser
      summary: Invite a new user
      description: |
        Send an invitation email to a new user. They will complete
        registration via the invitation link.
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteUserRequest'
      responses:
        '201':
          description: Invitation sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInvitation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: User already exists or has pending invitation

  /users/import:
    post:
      operationId: importUsers
      summary: Bulk import users
      description: Import multiple users from CSV or JSON
      tags:
        - Bulk Operations
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV or JSON file with user data
                send_invitations:
                  type: boolean
                  default: true
                  description: Send invitation emails to new users
                update_existing:
                  type: boolean
                  default: false
                  description: Update existing users if email matches
      responses:
        '202':
          description: Import job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportJobResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/export:
    post:
      operationId: exportUsers
      summary: Export users
      description: Export user data to CSV or JSON
      tags:
        - Bulk Operations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [csv, json]
                  default: csv
                fields:
                  type: array
                  items:
                    type: string
                  description: Fields to include in export
                filters:
                  type: object
                  description: Filter criteria (same as list endpoint)
      responses:
        '202':
          description: Export job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJobResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/stats:
    get:
      operationId: getUserStats
      summary: Get user statistics
      description: Get aggregated user statistics for the tenant
      tags:
        - Users
      responses:
        '200':
          description: User statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserStats'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UserIdParam:
      name: userId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: User ID

    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number

    PageSizeParam:
      name: page_size
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Items per page

    SortParam:
      name: sort
      in: query
      schema:
        type: string
        pattern: '^-?[a-z_]+$'
        default: '-created_at'
      description: Sort field (prefix with - for descending)

    SearchParam:
      name: search
      in: query
      schema:
        type: string
        minLength: 2
      description: Search in name, email

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    UserStatus:
      type: string
      enum:
        - active
        - inactive
        - pending
        - suspended
        - deleted
      description: User account status

    User:
      type: object
      required:
        - id
        - email
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
        email:
          type: string
          format: email
          description: User's email address
        email_verified:
          type: boolean
          description: Whether email is verified
        name:
          type: string
          description: Full name
        given_name:
          type: string
          description: First name
        family_name:
          type: string
          description: Last name
        picture:
          type: string
          format: uri
          description: Profile picture URL
        phone:
          type: string
          description: Phone number
        phone_verified:
          type: boolean
          description: Whether phone is verified
        status:
          $ref: '#/components/schemas/UserStatus'
        roles:
          type: array
          items:
            type: string
          description: Assigned roles
        team_id:
          type: string
          format: uuid
          description: Team/department ID
        team_name:
          type: string
          description: Team/department name
        tenant_id:
          type: string
          format: uuid
          description: Tenant/organization ID
        metadata:
          type: object
          additionalProperties: true
          description: Custom metadata
        last_login_at:
          type: string
          format: date-time
          description: Last login timestamp
        created_at:
          type: string
          format: date-time
          description: Account creation time
        updated_at:
          type: string
          format: date-time
          description: Last update time

    CreateUserRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          format: password
          minLength: 8
          description: Initial password (optional if invitation flow)
        name:
          type: string
          maxLength: 100
          description: Full name
        given_name:
          type: string
          maxLength: 50
          description: First name
        family_name:
          type: string
          maxLength: 50
          description: Last name
        phone:
          type: string
          description: Phone number
        roles:
          type: array
          items:
            type: string
          description: Initial roles
        team_id:
          type: string
          format: uuid
          description: Team assignment
        metadata:
          type: object
          additionalProperties: true
          description: Custom metadata
        send_invitation:
          type: boolean
          default: true
          description: Send invitation email

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        given_name:
          type: string
          maxLength: 50
        family_name:
          type: string
          maxLength: 50
        phone:
          type: string
        team_id:
          type: string
          format: uuid
        metadata:
          type: object
          additionalProperties: true

    InviteUserRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        roles:
          type: array
          items:
            type: string
        team_id:
          type: string
          format: uuid
        message:
          type: string
          maxLength: 500
          description: Custom message in invitation email
        expires_in:
          type: integer
          minimum: 3600
          maximum: 604800
          default: 259200
          description: Invitation expiry in seconds (default 3 days)

    UserInvitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        status:
          type: string
          enum: [pending, accepted, expired]
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    UserListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Pagination:
      type: object
      required:
        - page
        - page_size
        - total_items
        - total_pages
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total_items:
          type: integer
        total_pages:
          type: integer
        has_next:
          type: boolean
        has_previous:
          type: boolean

    UserStats:
      type: object
      properties:
        total_users:
          type: integer
        active_users:
          type: integer
        pending_users:
          type: integer
        suspended_users:
          type: integer
        users_by_role:
          type: object
          additionalProperties:
            type: integer
        users_created_last_30_days:
          type: integer
        users_active_last_7_days:
          type: integer

    ImportJobResponse:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        message:
          type: string

    ExportJobResponse:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        download_url:
          type: string
          format: uri
          description: URL to download export (when completed)
        expires_at:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error details
        request_id:
          type: string
          description: Request ID for debugging
